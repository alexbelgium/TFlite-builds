name: Build TFLite Runtime Wheels

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        python_version: ["3.9", "3.10", "3.11", "3.12"]
        arch: ["amd64", "aarch64"]

    steps:
    - name: Checkout TensorFlow
      uses: actions/checkout@v4
      with:
        repository: tensorflow/tensorflow
        submodules: true
        fetch-depth: 0
        ref: v2.18.0

    - name: Setup Docker and Dependencies
      run: |
        sudo apt-get remove -y containerd
        sudo apt update
        sudo apt install -y docker.io software-properties-common
        sudo add-apt-repository ppa:deadsnakes/ppa -y
        sudo apt-get update
        sudo apt-get install -y \
          python${{ matrix.python_version }} build-essential lld git zip unzip pkg-config curl \
          python${{ matrix.python_version }}-dev python${{ matrix.python_version }}-venv gcc-12 clang-17

    - name: Adjust Dockerfile for Python >= 3.11
      if: matrix.python_version == '3.11' || matrix.python_version == '3.12'
      run: |
        sed -i '/get-pip.py/a RUN rm /usr/lib/python${PYTHON_VERSION}/EXTERNALLY-MANAGED' tensorflow/lite/tools/pip_package/Dockerfile.py3

    - name: Configure Makefile
      run: |
        sed -i 's/^BASE_IMAGE.*/BASE_IMAGE ?= ubuntu:22.04/' tensorflow/lite/tools/pip_package/Makefile
        sed -i 's/^PYTHON_VERSION.*/PYTHON_VERSION ?= ${{ matrix.python_version }}/' tensorflow/lite/tools/pip_package/Makefile
        sed -i 's/^NUMPY_VERSION.*/NUMPY_VERSION ?= 1.24.4/' tensorflow/lite/tools/pip_package/Makefile

    - name: Build TFLite Runtime Wheel using Docker
      run: |
        BUILD_NUM_JOBS=$(nproc) make -C tensorflow/lite/tools/pip_package docker-build TENSORFLOW_TARGET=${{ matrix.arch }} PYTHON_VERSION=${{ matrix.python_version }}

    - name: Upload TFLite Wheel
      uses: actions/upload-artifact@v4
      with:
        name: tflite_runtime-${{ matrix.arch }}-py${{ matrix.python_version }}
        path: tensorflow/lite/tools/pip_package/gen/tflite_pip/python/dist/*.whl
